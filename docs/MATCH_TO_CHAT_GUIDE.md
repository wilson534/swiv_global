# 匹配到聊天完整流程指南

## 🎯 功能说明

现在匹配功能已经完全连接到 Supabase，右滑喜欢后会：

1. ✅ 记录您的 swipe 到数据库
2. ✅ 检查是否双向匹配（对方也喜欢您）
3. ✅ 如果匹配成功，自动创建 match 记录
4. ✅ 聊天页面实时显示新的匹配
5. ✅ 支持发送和接收消息

---

## 📋 前置步骤

### 1. 执行数据库架构（如果还没执行）

在 Supabase SQL Editor 中执行：
```
https://supabase.com/dashboard/project/qjvexoyuqsvowkqwlyci/sql/new
```

复制并执行：`docs/supabase_schema.sql`

### 2. 插入测试数据

在同一个 SQL Editor 中执行：`docs/test_chat_data.sql`

这会创建：
- ✅ 4 个测试用户（包括 demo_wallet_123）
- ✅ 3 个测试人格
- ✅ **3 个其他用户已经喜欢了您**（预先创建的 swipes）

---

## 🚀 使用流程

### 步骤 1: 查看匹配页面

1. 打开应用
2. 点击底部 "💞 匹配" 标签
3. 看到候选用户卡片

### 步骤 2: 右滑喜欢

1. **向右滑动卡片** 或 **点击右下角 ❤️ 按钮**
2. 应用会：
   - 记录您的 like 到数据库
   - 检查对方是否也喜欢您
   - 如果是双向喜欢，自动创建 match

### 步骤 3: 匹配成功

如果对方也喜欢您，会看到：

```
匹配成功！💞

你和 7xKXtg2CW87dAbcDEfGH 互相喜欢！
匹配度: 88%

现在可以开始聊天了！

[继续匹配]  [去聊天 💬]
```

### 步骤 4: 进入聊天

点击 "去聊天 💬" 或手动切换到聊天标签，您会看到：

- ✅ 新的匹配出现在聊天列表顶部
- ✅ 显示对方钱包地址
- ✅ 显示投资风格（保守/平衡/激进）
- ✅ 可以点击进入聊天室

### 步骤 5: 发送消息

1. 点击匹配进入聊天室
2. 输入消息
3. 点击发送 🚀
4. 消息会：
   - 保存到 Supabase
   - 实时显示在聊天中
   - 支持多设备同步

---

## 🧪 测试数据说明

执行 `test_chat_data.sql` 后：

### 预设的喜欢（其他用户已喜欢您）:
- ✅ `7xKXtg2CW87dAbcDEfGH` 已喜欢您
- ✅ `9pQRst3DX92fXyZaBcDe` 已喜欢您
- ✅ `4mNOuv5EY83gPqRsTuVw` 已喜欢您

**这意味着：** 当您右滑喜欢这些用户时，会立即匹配成功！

---

## 🔍 数据流

```
1. 用户右滑 →
2. recordSwipe(your_wallet, target_wallet, 'like') →
3. 插入 swipes 表 →
4. 检查对方是否也喜欢 →
5. 如果是，创建 matches 记录 →
6. 返回 { matched: true } →
7. 显示匹配成功对话框 →
8. 聊天页面加载新匹配 →
9. 用户可以开始聊天
```

---

## 📊 数据库表关系

```
profiles (用户)
    ↓
personas (投资人格)
    ↓
swipes (滑动记录)
    ↓
matches (双向匹配)
    ↓
messages (聊天消息)
```

---

## 🐛 故障排查

### 问题：右滑后没有显示匹配成功

**原因：** 对方还没有喜欢您

**解决：**
1. 确保已执行 `test_chat_data.sql`
2. 检查是否有 swipes 记录：
```sql
SELECT * FROM swipes 
WHERE to_profile IN (
  SELECT id FROM profiles WHERE wallet_address = 'demo_wallet_123'
) AND action = 'like';
```

### 问题：聊天页面显示"暂无聊天"

**原因：** 还没有匹配成功的记录

**解决：**
1. 右滑喜欢至少一个用户
2. 等待匹配成功提示
3. 点击"去聊天"或刷新聊天页面

### 问题：无法发送消息

**原因：** 
- Supabase 连接问题
- 权限问题

**解决：**
1. 检查环境变量是否正确
2. 检查 Supabase URL 和 Key
3. 查看控制台错误日志

---

## ✅ 功能清单

- [x] 右滑记录到数据库
- [x] 左滑记录到数据库
- [x] 双向匹配检测
- [x] 自动创建 match 记录
- [x] 聊天列表显示匹配
- [x] 实时消息订阅
- [x] 发送消息到数据库
- [x] 未读消息计数
- [x] 时间格式化

---

## 🎉 完成！

现在您的匹配和聊天功能已完全集成！

**测试流程：**
1. ✅ 执行 SQL 脚本
2. ✅ 打开匹配页面
3. ✅ 右滑喜欢 `7xKXtg2CW87dAbcDEfGH`
4. ✅ 看到"匹配成功！💞"提示
5. ✅ 点击"去聊天 💬"
6. ✅ 看到新的匹配出现
7. ✅ 开始聊天！



